services:
  frankenphp:
    container_name: klinik
    image: klinik-app
    build:
      context: .
      args:
        UID: ${UID:-1000}
        GID: ${GID:-1000}
        XDEBUG_ENABLED: ${XDEBUG_ENABLED:-true}
        XDEBUG_MODE: develop,coverage,debug,profile
        XDEBUG_HOST: ${XDEBUG_HOST:-host.docker.internal}
        XDEBUG_IDE_KEY: ${XDEBUG_IDE_KEY:-DOCKER}
        XDEBUG_LOG: /dev/stdout
        XDEBUG_LOG_LEVEL: 0
    entrypoint: php artisan octane:start --server=frankenphp --host=0.0.0.0 --port=${FRANKEN_PORT:-8002} --workers=4 --max-requests=1000
    ports:
      - "${FRANKEN_PORT:-8002}:${FRANKEN_PORT:-8002}"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - klinik_vendor:/app/vendor
      - klinik_storage:/app/storage
      - klinik_cache:/app/bootstrap/cache
      - klinik_storage:/app/storage
    restart: unless-stopped
    networks:
      - klinik-project
    env_file:
      - .env
    environment:
      XDG_CONFIG_HOME: /var/www/html/config
      XDG_DATA_HOME: /var/www/html/data
    user: "${UID:-1000}:${GID:-1000}"

  caddy:
    image: caddy:latest
    container_name: klinik_caddy
    restart: always
    ports:
      - "80:80"    # port host 8081 ke container 80
      - "8444:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - frankenphp
    networks:
      - klinik-project

networks:
  klinik-project:
    driver: bridge

volumes:
  caddy_data:
  caddy_config: